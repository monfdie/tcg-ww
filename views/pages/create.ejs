<%- include('../partials/header') %>

<div style="display: flex; justify-content: center; margin-top: 50px;">
    <div class="lobby-card">
        <h1>Create Room</h1>
        <div class="input-group">
            <label>NICKNAME</label>
            <input id="nickname-input" placeholder="Enter Name" maxlength="15" 
                   value="<%= locals.user ? (locals.user.global_name || locals.user.username) : '' %>">
        </div>
     
        <div class="input-group">
            <label>DRAFT MODE</label>
            <select id="draft-type-select">
                <option value="gitcg">GITCG CUP </option>
                <option value="gitcg_cup_2">GITCG CUP 2 (Immunity)</option>
                <option value="classic">Classic (2 Bans / 3 Picks)</option>
                <option value="generals_2">Generals 2 (New)</option>
            </select>
        </div>
        <button class="btn-primary" onclick="createGame()">Create Game</button>
        
        <div class="separator"><span>OR JOIN</span></div>
        
        <div class="input-group">
            <label>ROOM CODE</label>
            <input id="room-input" placeholder="Enter Code" style="text-transform: uppercase;">
        </div>
        <div class="input-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 5px;">
            <input type="checkbox" id="spectator-check" style="width: auto; margin: 0;">
            <label for="spectator-check" style="margin: 0; cursor: pointer;">Join as Spectator</label>
        </div>
        <button class="btn-secondary" onclick="joinGame()">Join Game</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io({ transports: ['websocket'] });
    
    const discordId = '<%= locals.user ? locals.user.id : "" %>';
    let myUserId = discordId || sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
    sessionStorage.setItem('draft_user_id', myUserId);

    function createGame() { 
        const nickInput = document.getElementById('nickname-input');
        const typeSelect = document.getElementById('draft-type-select');
        
        if (!nickInput) return;
        const nick = nickInput.value.trim();
        const type = typeSelect ? typeSelect.value : 'gitcg';
        
        if(!nick) {
            alert("Пожалуйста, введите никнейм!");
            return;
        }
        
        sessionStorage.setItem('draft_nickname', nick);
        socket.emit('create_game', { nickname: nick, draftType: type, userId: myUserId }); 
    }

    function joinGame() {
        const roomInput = document.getElementById('room-input');
        const nickInput = document.getElementById('nickname-input');
        const specCheck = document.getElementById('spectator-check');

        if(!roomInput || !nickInput) return;

        const room = roomInput.value.toUpperCase().trim();
        const nick = nickInput.value.trim();
        
        if(!room) {
            alert("Введите код комнаты!");
            return;
        }
        if(!nick) {
            alert("Введите никнейм перед входом!");
            return;
        }
        
        sessionStorage.setItem('draft_nickname', nick);
        sessionStorage.setItem('join_as_spectator', specCheck ? specCheck.checked : false);
        
        window.location.href = `/game/${room}`;
    }

    socket.on('init_game', (data) => {
        if (data && data.roomId) {
            sessionStorage.setItem('draft_room_id', data.roomId);
            window.location.href = `/game/${data.roomId}`;
        }
    });

    socket.on('error_msg', (msg) => {
        alert("Ошибка: " + msg);
    });
</script>

<%- include('../partials/footer') %>
