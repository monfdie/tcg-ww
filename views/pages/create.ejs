<%- include('../partials/header') %>

<div style="display: flex; justify-content: center; margin-top: 50px;">
    <div class="lobby-card">
        <h1>Create Room</h1>
        <div class="input-group">
            <label>NICKNAME</label>
            <input id="nickname-input" placeholder="Enter Name" maxlength="15" 
                   value="<%= locals.user ? (locals.user.global_name || locals.user.username) : '' %>">
        </div>
        <div class="input-group">
            <label>DRAFT MODE</label>
            <select id="draft-type-select">
                <option value="gitcg">GITCG CUP </option>
                <option value="gitcg_cup_2">GITCG CUP 2 (Immunity)</option>
                <option value="classic">Classic (2 Bans / 3 Picks)</option>
                <option value="generals_2">Generals 2</option>
            </select>
        </div>
        <button class="btn-primary" onclick="createGame()">Create Game</button>
        
        <div class="separator"><span>OR JOIN</span></div>
        
        <div class="input-group">
            <label>ROOM CODE</label>
            <input id="room-input" placeholder="Enter Code" style="text-transform: uppercase;">
        </div>
        <button class="btn-secondary" onclick="joinGame()">Join Game</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io({ transports: ['websocket'] });
    
    const myRealDiscordId = '<%= locals.user ? locals.user.discordId : "" %>';
    const myAvatarHash = '<%= locals.user ? locals.user.avatar : "" %>';
    
    let myUserId = myRealDiscordId || sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
    sessionStorage.setItem('draft_user_id', myUserId);

    function createGame() { 
        const nick = document.getElementById('nickname-input').value;
        const type = document.getElementById('draft-type-select').value;
        if(!nick) return alert("Enter nickname!");
        
        socket.emit('create_game', { 
            nickname: nick, draftType: type, userId: myUserId,
            discordId: myRealDiscordId, avatar: myAvatarHash 
        }); 
    }

    function joinGame() {
        const room = document.getElementById('room-input').value.toUpperCase();
        if(!room) return alert("Enter code!");
        
        sessionStorage.setItem('draft_nickname', document.getElementById('nickname-input').value);
        window.location.href = `/game/${room}`;
    }

    socket.on('init_game', (data) => {
        sessionStorage.setItem('draft_room_id', data.roomId);
        sessionStorage.setItem('draft_nickname', document.getElementById('nickname-input').value);
        window.location.href = `/game/${data.roomId}`;
    });
</script>

<%- include('../partials/footer') %>
