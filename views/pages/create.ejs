<%- include('../partials/header') %>

<style>
    .create-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 50px;
        margin-top: 80px;
        flex-wrap: wrap;
        padding: 0 20px;
    }

    .panel-card {
        background: rgba(22, 28, 48, 0.9);
        border: 1px solid #2a3454;
        border-radius: 12px;
        padding: 40px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        transition: transform 0.3s;
    }
    .panel-card:hover {
        transform: translateY(-5px);
        border-color: #4facfe;
    }

    h2 {
        font-family: 'Cinzel', serif;
        color: #fff;
        font-size: 2em;
        margin-bottom: 30px;
        text-shadow: 0 0 10px rgba(79, 172, 254, 0.4);
    }

    input, select {
        width: 100%;
        padding: 15px;
        margin-bottom: 20px;
        background: #0f131f;
        border: 1px solid #3c4566;
        border-radius: 6px;
        color: #fff;
        font-size: 1.1em;
        box-sizing: border-box;
        text-align: center;
    }
    input:focus, select:focus {
        border-color: #d4af37;
        outline: none;
    }

    .action-btn {
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
        font-weight: bold;
        text-transform: uppercase;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
        font-family: 'Cinzel', serif;
    }

    .btn-create {
        background: linear-gradient(45deg, #d4af37, #f2d06b);
        color: #0b0d17;
    }
    .btn-create:hover {
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }

    .btn-join {
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        color: #0b0d17;
    }
    .btn-join:hover {
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
    }

    label {
        display: block;
        color: #8da4c4;
        margin-bottom: 10px;
        text-align: left;
    }
</style>

<div class="create-container">

    <div class="panel-card">
        <h2>Create Game</h2>
        
        <label>Your Nickname:</label>
        <input type="text" id="create-nick" placeholder="<%= locals.user ? locals.user.username : 'Player 1' %>" value="<%= locals.user ? locals.user.username : '' %>">

        <label>Mode / Format:</label>
        <select id="draft-type">
            <option value="gitcg">GITCG (Standard)</option>
            <option value="gitcg_cup_2">GITCG Cup 2 (Immunity)</option>
            <option value="generals_2">2 Generals</option>
            <option value="classic">Classic</option>
        </select>

        <button class="action-btn btn-create" onclick="createGame()">Create Lobby</button>
    </div>

    <div class="panel-card">
        <h2>Join Game</h2>

        <label>Room Code:</label>
        <input type="text" id="join-code" placeholder="XXXX" style="text-transform: uppercase; letter-spacing: 3px; font-weight: bold;">

        <label>Your Nickname:</label>
        <input type="text" id="join-nick" placeholder="<%= locals.user ? locals.user.username : 'Player 2' %>" value="<%= locals.user ? locals.user.username : '' %>">

        <button class="action-btn btn-join" onclick="joinGame()">Join Lobby</button>
    </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    
    // Получаем данные юзера из EJS (если залогинен)
    const userId = '<%= locals.user ? locals.user._id : Math.random().toString(36).substr(2, 9) %>';
    const discordId = '<%= locals.user ? locals.user.discordId : "" %>';
    const avatar = '<%= locals.user ? locals.user.avatar : "" %>';

    // Сохраняем ID для переподключения
    sessionStorage.setItem('draft_user_id', userId);

    socket.on('init_game', (data) => {
        window.location.href = `/game/${data.roomId}`;
    });

    socket.on('error_msg', (msg) => {
        alert(msg);
    });

    function createGame() {
        const nick = document.getElementById('create-nick').value || '<%= locals.user ? locals.user.username : "Player 1" %>';
        const type = document.getElementById('draft-type').value;
        
        socket.emit('create_game', { 
            nickname: nick, 
            draftType: type,
            userId: userId,
            discordId: discordId,
            avatar: avatar
        });
    }

    function joinGame() {
        const code = document.getElementById('join-code').value.trim().toUpperCase();
        const nick = document.getElementById('join-nick').value || '<%= locals.user ? locals.user.username : "Player 2" %>';

        if (!code) {
            alert("Please enter a Room Code");
            return;
        }

        // Мы всегда отправляем asSpectator: false (или undefined)
        // Сервер сам решит: если мест нет -> кинет в зрители.
        socket.emit('join_game', { 
            roomId: code, 
            nickname: nick, 
            userId: userId,
            asSpectator: false 
        });
    }
</script>

<%- include('../partials/footer') %>
