<%- include('../partials/header') %>

<div id="game-screen" style="display: flex; flex-direction: column; height: 100%; width: 100%; margin-top: -40px;">
    
    <div class="header" style="height: 6vh; display: flex; gap: 30px; align-items: center; justify-content: center; background: rgba(10, 12, 20, 0.95); border-bottom: 2px solid #222; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 30; flex-shrink: 0;">
        <div id="room-container" style="position: absolute; left: 20px; display: flex; align-items: center; gap: 10px;">
            <div id="room-display" onclick="copyRoomCode()" title="Click to copy room code" style="font-family: 'Segoe UI', monospace; font-size: 14px; color: #d4af37; background: rgba(255, 215, 0, 0.1); padding: 4px 8px; border: 1px solid #554400; border-radius: 4px; cursor: pointer;">CODE: <%= roomId %></div>
            <span id="copy-toast" style="visibility: hidden; background-color: #28a745; color: #fff; padding: 4px 8px; font-size: 12px; border-radius: 4px;">Code Copied!</span>
        </div>
        <div class="reserve-timer blue-res" style="color: #4facfe; font-size: 18px; font-weight: bold; font-family: 'Cinzel', serif;"><span id="blue-res">5:00</span></div>
        <div id="status" style="font-size: 16px; color: #aaa; text-transform: uppercase; letter-spacing: 2px;">Waiting...</div>
        <div class="reserve-timer red-res" style="color: #ff6b6b; font-size: 18px; font-weight: bold; font-family: 'Cinzel', serif;"><span id="red-res">5:00</span></div>
    </div>

    <div class="draft-area">
        <div id="immunity-top-display" class="immunity-top-container" style="display: none;">
            <div class="im-label">IMMUNE</div>
            <div class="im-row" id="immunity-icons-row"></div>
        </div>

        <div class="team-side blue-side">
            <div class="player-header">
                <div id="blue-timer" class="turn-timer">60</div>
                <h2 id="blue-name-display">PLAYER 1</h2>
                <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                    <div class="switch-circle"></div>
                </div>
            </div>
            <div class="ban-row" id="blue-bans"></div>
            <div class="pick-row" id="blue-picks-1"></div>
            <div class="pick-row-small" id="blue-picks-2"></div>
        </div>

        <div class="center-axis">
            <div class="mid-label ban-label">BANS</div>
            <div class="mid-label pick-label">PICKS</div>
        </div>

        <div class="team-side red-side">
            <div class="player-header">
                <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                    <div class="switch-circle"></div>
                </div>
                <h2 id="red-name-display">PLAYER 2</h2>
                <div id="red-timer" class="turn-timer">60</div>
            </div>
            <div class="ban-row" id="red-bans"></div>
            <div class="pick-row" id="red-picks-1"></div>
            <div class="pick-row-small" id="red-picks-2"></div>
        </div>
    </div>

    <div class="controls-area">
        <button id="skip-btn" class="round-btn" onclick="skipTurn()">SKIP</button>
        <button id="confirm-btn" class="confirm-btn round-btn" onclick="confirmSelection()" disabled>SELECT</button>
    </div>

    <div class="char-pool" id="char-pool-container"></div>
</div>

// Передаем данные из базы в JS (если они есть)
const savedMatchData = <%- savedData ? JSON.stringify(savedData) : 'null' %>;

if (savedMatchData) {
    console.log("Загружена завершенная игра из истории");
    // Здесь мы вызываем отрисовку состояния сразу
    window.onload = () => {
        // Заполняем интерфейс данными из базы
        updateUIFromHistory(savedMatchData);
    };
}

function updateUIFromHistory(data) {
    // Убираем экран ожидания и кнопки готовности
    const overlay = document.getElementById('ready-overlay');
    if (overlay) overlay.style.display = 'none';

    // Обновляем имена
    document.getElementById('blue-name').innerText = data.blueName;
    document.getElementById('red-name').innerText = data.redName;

    // Отрисовываем пики (тебе нужно будет вызвать свои функции отрисовки)
    // Например:
    renderPicks(data.bluePicks, 'blue');
    renderPicks(data.redPicks, 'red');
    renderBans(data.bans);
    
    // Пишем, что игра завершена
    document.getElementById('status-text').innerText = "DRAFT COMPLETED (HISTORY)";
}

<script src="/socket.io/socket.io.js"></script>
<script src="/draft-rules.js"></script> 

<script>
    // Получаем ID комнаты из шаблона EJS (передано сервером)
    const currentRoom = '<%= roomId %>'; 
    const socket = io({ transports: ['websocket'] });

    let myRole = '', currentDraftType = 'gitcg';
    let charsData = {}, selectedCharId = null, isGameStarted = false, activeTeam = 'blue'; 
    
    // Берем ID юзера и никнейм из сессии
    let myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
    sessionStorage.setItem('draft_user_id', myUserId);
    const myNickname = sessionStorage.getItem('draft_nickname') || 'Player';

    // Как только подключились — сразу просим сервер присоединить нас к этой комнате
    socket.on('connect', () => {
        // Проверяем, может мы создатель, который только что редиректнулся сюда
        const savedRoom = sessionStorage.getItem('draft_room_id');
        if (savedRoom === currentRoom) {
             // Мы создали эту комнату или уже были в ней
             socket.emit('rejoin_game', { roomId: currentRoom, userId: myUserId });
        } else {
             // Мы перешли по ссылке-инвайту
             // По умолчанию заходим как зритель, если места заняты, или как Player 2, если есть место
             socket.emit('join_game', {roomId: currentRoom, nickname: myNickname, asSpectator: false, userId: myUserId});
        }
    });

    socket.on('error_msg', (msg) => {
        if (msg === 'Session expired' || msg === 'Room not found') {
            sessionStorage.removeItem('draft_room_id'); 
            alert("Game session expired or room not found.");
            window.location.href = "/"; // Если ошибка - кидаем на главную
        } else {
            alert(msg);
        }
    });

    socket.on('init_game', (data) => {
        myRole = data.role; charsData = data.chars;
        currentDraftType = data.state.draftType || 'gitcg';
        sessionStorage.setItem('draft_room_id', currentRoom);
        
        const specTag = myRole === 'spectator' ? " (SPEC)" : "";
        document.getElementById('room-display').innerText = `CODE: ${currentRoom}${specTag}`;
        
        renderRows(); 
        updateUI(data.state);
    });

    socket.on('update_state', updateUI);
    socket.on('game_started', () => { isGameStarted = true; });
    socket.on('game_over', (state) => { 
        updateUI(state); 
        setTimeout(() => alert("Draft Completed!"), 500); 
        sessionStorage.removeItem('draft_room_id'); 
    });
    
    socket.on('timer_tick', (data) => {
        const t = typeof data === 'object' ? data.main : data;
        const b = document.getElementById('blue-timer'), r = document.getElementById('red-timer');
        if(activeTeam==='blue') { b.innerText=t; r.innerText="60"; b.style.color=t<10?'#ff5555':'#4facfe'; }
        else { r.innerText=t; b.innerText="60"; r.style.color=t<10?'#ff5555':'#ff6b6b'; }
        if(typeof data === 'object') {
            document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
            document.getElementById('red-res').innerText = formatTime(data.redReserve);
        }
    });

    function formatTime(s) { 
        if (s < 0) s = 0; 
        const m=Math.floor(s/60), sec=s%60; 
        return `${m}:${sec<10?'0':''}${sec}`; 
    }

    function toggleReady(r) { if(myRole===r) socket.emit('player_ready', currentRoom); }
    
    function copyRoomCode() { 
        if (!currentRoom) return;
        navigator.clipboard.writeText(currentRoom).then(() => {
            const toast = document.getElementById('copy-toast');
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2000);
        });
    }
    
    function skipTurn() {
        if(currentRoom) socket.emit('skip_action', currentRoom);
    }
    
    function renderRows() {
        const container = document.getElementById('char-pool-container');
        container.innerHTML = '';
        const ladder = document.createElement('div'); ladder.className = 'ladder-container';
        const schema = DRAFT_RULES[currentDraftType];
        
        schema.forEach((step, i) => {
            const d = document.createElement('div');
            
            const sideClass = step.team === 'blue' ? 'step-left' : 'step-right';
            let colorClass = 'step-pick'; 
            if (step.type.includes('ban')) colorClass = 'step-ban'; 
            else if (step.immunity) colorClass = 'step-immunity'; 
            
            d.className = `ladder-step ${sideClass} ${colorClass}`;
            d.id = `step-node-${i}`; d.innerText = `${i+1}. ${step.type}`;
            ladder.appendChild(d);
        });
        container.appendChild(ladder);

        ['cryo','hydro','pyro','electro','anemo','geo','dendro'].forEach(elem => {
            const row = document.createElement('div'); row.className = `element-row row-${elem}`;
            const chars = charsData[elem], mid = Math.ceil(chars.length/2);
            const l = document.createElement('div'); l.className = 'row-half left-half';
            chars.slice(0,mid).forEach(c => l.appendChild(createChar(c)));
            const gap = document.createElement('div'); gap.className = 'row-gap';
            const r = document.createElement('div'); r.className = 'row-half right-half';
            chars.slice(mid).forEach(c => r.appendChild(createChar(c)));
            row.appendChild(l); row.appendChild(gap); row.appendChild(r);
            container.appendChild(row);
        });
    }

    function createChar(char) {
        const el = document.createElement('div'); el.className = 'char-option'; el.id = `char-${char.id}`;
        el.innerHTML = `<img src="${char.img}">`;
        el.onclick = () => {
            if(!isGameStarted || myRole === 'spectator') return;
            document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
            selectedCharId = char.id; el.classList.add('selected-pending');
            document.getElementById('confirm-btn').disabled = false;
        };
        return el;
    }

    function confirmSelection() {
        if(selectedCharId && currentRoom) {
            socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
            selectedCharId = null; document.getElementById('confirm-btn').disabled = true;
            document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
        }
    }

    function updateImmunityTop(state) {
        const topDisp = document.getElementById('immunity-top-display');
        if(state.draftType !== 'gitcg_cup_2') { topDisp.style.display = 'none'; return; }
        topDisp.style.display = 'flex';
        const row = document.getElementById('immunity-icons-row');
        row.innerHTML = '';
        const bans = state.immunityBans || [];
        const picks = state.immunityPool || [];
        const slots = [ { id: bans[0], type: 'ban' }, { id: picks[0], type: 'pick' }, { id: picks[1], type: 'pick' }, { id: bans[1], type: 'ban' } ];
        slots.forEach(slot => {
            const div = document.createElement('div');
            div.className = `im-icon im-${slot.type}`;
            if (slot.id === 'skipped') {
                div.innerHTML = `<span style="color:#aaa; font-size:20px; line-height:36px; display:block; text-align:center;">✖</span>`;
                div.style.background = '#222';
            } else if (slot.id) {
                let all = []; Object.values(charsData).forEach(a => all.push(...a));
                const char = all.find(c => c.id === slot.id);
                if(char) div.innerHTML = `<img src="${char.img}">`;
            } else div.classList.add('im-empty');
            row.appendChild(div);
        });
    }

    function updateUI(state) {
        isGameStarted = state.gameStarted; activeTeam = state.currentTeam;
        document.getElementById('blue-ready-switch').style.display = state.gameStarted?'none':'flex';
        document.getElementById('red-ready-switch').style.display = state.gameStarted?'none':'flex';
        if(!state.gameStarted) {
            state.ready.blue ? document.getElementById('blue-ready-switch').classList.add('ready-on') : document.getElementById('blue-ready-switch').classList.remove('ready-on');
            state.ready.red ? document.getElementById('red-ready-switch').classList.add('ready-on') : document.getElementById('red-ready-switch').classList.remove('ready-on');
        }
        document.getElementById('blue-name-display').innerText = state.blueName;
        document.getElementById('red-name-display').innerText = state.redName;
        
        let txt = "WAITING...";
        if(state.immunityPhaseActive) txt = `IMMUNITY: ${state.currentTeam} ${state.currentAction}`;
        else if(state.gameStarted) txt = `${state.currentTeam} IS ${state.currentAction==='ban'?'BANNING':'PICKING'}`;
        document.getElementById('status').innerText = txt.toUpperCase();

        updateImmunityTop(state);

        // Кнопка SKIP
        const skipBtn = document.getElementById('skip-btn');
        const isMyTurn = (myRole === state.currentTeam);
        
        skipBtn.classList.remove('skip-left', 'skip-right');
        
        if (state.immunityPhaseActive && isMyTurn) {
            skipBtn.style.display = 'block';
            if (state.currentTeam === 'blue') skipBtn.classList.add('skip-left');
            else skipBtn.classList.add('skip-right');
        } else {
            skipBtn.style.display = 'none';
        }

        const idx = state.stepIndex - 1;
        const currentSchema = DRAFT_RULES[currentDraftType];
        const len = currentSchema.length;

        if(!state.immunityPhaseActive) {
            for(let i=0; i<len; i++) {
                const n = document.getElementById(`step-node-${i}`);
                if(!n) continue;
                n.classList.remove('step-active','step-done');
                if(i < idx) n.classList.add('step-done');
                else if(i === idx && state.gameStarted) {
                    n.classList.add('step-active');
                    setTimeout(() => n.scrollIntoView({behavior:'smooth', block:'center'}), 50);
                }
            }
        }

        renderSlots(state);

        document.querySelectorAll('.char-option').forEach(el => el.classList.remove('disabled', 'immunity-highlight'));
        state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
        [...state.bluePicks, ...state.redPicks].forEach(id => document.getElementById(`char-${id}`)?.classList.add('disabled'));
        if(state.immunityPhaseActive) {
            [...state.immunityBans, ...state.immunityPool].forEach(id => {
                if(id !== 'skipped') document.getElementById(`char-${id}`)?.classList.add('disabled');
            });
        } else {
            const step = currentSchema[idx];
            const isImmunityTurn = step && step.immunity;
            state.immunityPool.forEach(id => {
                if(id === 'skipped') return;
                const el = document.getElementById(`char-${id}`);
                if(!el) return;
                if(state.currentAction === 'ban') el.classList.add('disabled');
                else if (state.currentAction === 'pick') {
                    if(isImmunityTurn) {
                        const myPicks = activeTeam === 'blue' ? state.bluePicks : state.redPicks;
                        if(!myPicks.includes(id)) { el.classList.remove('disabled'); el.classList.add('immunity-highlight'); }
                    } else el.classList.add('disabled');
                }
            });
        }
        if(state.gameStarted && myRole !== 'spectator' && myRole !== state.currentTeam) {
            document.querySelectorAll('.char-option').forEach(el => el.classList.add('disabled'));
        }
    }

    function getStepsFor(schema, team, type) {
        if (!schema) return [];
        return schema
            .map((step, index) => ({ ...step, globalIndex: index + 1 }))
            .filter(step => step.team === team && step.type === type)
            .map(step => ({ num: step.globalIndex, immunity: step.immunity }));
    }

    function renderSlots(state) {
        const currentSchema = DRAFT_RULES[currentDraftType];
        const blueBanSteps = getStepsFor(currentSchema, 'blue', 'ban');
        const redBanSteps = getStepsFor(currentSchema, 'red', 'ban');
        const bluePickSteps = getStepsFor(currentSchema, 'blue', 'pick');
        const redPickSteps = getStepsFor(currentSchema, 'red', 'pick');

        const fill = (containerId, items, stepData, isBan) => {
            const div = document.getElementById(containerId);
            div.innerHTML = ''; 
            stepData.forEach((step, i) => {
                const slot = document.createElement('div');
                slot.className = 'slot-circle';
                if (isBan) slot.classList.add('slot-ban');
                if (step.immunity) slot.classList.add('slot-immunity-pick');
                
                if (!state.immunityPhaseActive && state.gameStarted && step.num === state.stepIndex) {
                    slot.classList.add('active-slot');
                }

                let charId = null;
                if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];

                if (charId) {
                    let allFlat = []; Object.values(charsData).forEach(arr => allFlat.push(...arr));
                    const char = allFlat.find(c => c.id === charId);
                    if (char) slot.innerHTML = `<img src="${char.img}">`;
                } else slot.innerHTML = `<span class="step-number">${step.num}</span>`;
                div.appendChild(slot);
            });
        };

        fill('blue-bans', state.bans.filter(b => b.team === 'blue'), blueBanSteps, true);
        fill('red-bans', state.bans.filter(b => b.team === 'red'), redBanSteps, true);
        
        if (currentDraftType === 'generals_2') {
            fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
            fill('blue-picks-2', [], [], false); 
            fill('red-picks-1', state.redPicks, redPickSteps, false);
            fill('red-picks-2', [], [], false);
        } else if (currentDraftType === 'classic') {
            fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
            fill('blue-picks-2', [], [], false);
            fill('red-picks-1', state.redPicks, redPickSteps, false);
            fill('red-picks-2', [], [], false);
        } else {
            fill('blue-picks-1', state.bluePicks.slice(0, 5), bluePickSteps.slice(0, 5), false);
            fill('blue-picks-2', state.bluePicks.slice(5, 9), bluePickSteps.slice(5, 9), false);
            fill('red-picks-1', state.redPicks.slice(0, 5), redPickSteps.slice(0, 5), false);
            fill('red-picks-2', state.redPicks.slice(5, 9), redPickSteps.slice(5, 9), false);
        }
    }
</script>

<%- include('../partials/footer') %>
