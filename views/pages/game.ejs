<%- include('../partials/header') %>

<div id="game-screen" style="display: flex; flex-direction: column; height: 100%; width: 100%; margin-top: -40px;">
    <div class="header" style="height: 6vh; display: flex; gap: 30px; align-items: center; justify-content: center; background: rgba(10, 12, 20, 0.95); border-bottom: 2px solid #222; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 30; flex-shrink: 0;">
        <div id="room-container" style="position: absolute; left: 20px; display: flex; align-items: center; gap: 10px;">
            <div id="room-display" onclick="copyRoomCode()" style="font-family: 'Segoe UI', monospace; font-size: 14px; color: #d4af37; background: rgba(255, 215, 0, 0.1); padding: 4px 8px; border: 1px solid #554400; border-radius: 4px; cursor: pointer;">CODE: <%= roomId %></div>
            <span id="copy-toast" style="visibility: hidden; background-color: #28a745; color: #fff; padding: 4px 8px; font-size: 12px; border-radius: 4px;">Code Copied!</span>
        </div>
        <div class="reserve-timer blue-res"><span id="blue-res">5:00</span></div>
        <div id="status">Waiting...</div>
        <div class="reserve-timer red-res"><span id="red-res">5:00</span></div>
    </div>

    <div class="draft-area">
        <div id="immunity-top-display" class="immunity-top-container" style="display: none;">
            <div class="im-label">IMMUNE</div>
            <div class="im-row" id="immunity-icons-row"></div>
        </div>

        <div class="team-side blue-side">
            <div class="player-header">
                <div id="blue-timer" class="turn-timer">60</div>
                <h2 id="blue-name-display">PLAYER 1</h2>
                <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                    <div class="switch-circle"></div>
                </div>
            </div>
            <div class="ban-row" id="blue-bans"></div>
            <div class="pick-row" id="blue-picks-1"></div>
            <div class="pick-row-small" id="blue-picks-2"></div>
        </div>

        <div class="center-axis">
            <div class="mid-label ban-label">BANS</div>
            <div class="mid-label pick-label">PICKS</div>
        </div>

        <div class="team-side red-side">
            <div class="player-header">
                <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                    <div class="switch-circle"></div>
                </div>
                <h2 id="red-name-display">PLAYER 2</h2>
                <div id="red-timer" class="turn-timer">60</div>
            </div>
            <div class="ban-row" id="red-bans"></div>
            <div class="pick-row" id="red-picks-1"></div>
            <div class="pick-row-small" id="red-picks-2"></div>
        </div>
    </div>

    <div class="controls-area">
        <button id="skip-btn" class="round-btn" onclick="skipTurn()">SKIP</button>
        <button id="confirm-btn" class="confirm-btn round-btn" onclick="confirmSelection()" disabled>SELECT</button>
    </div>

    <div class="char-pool" id="char-pool-container"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/draft-rules.js"></script> 

<script>
    const currentRoom = '<%= roomId %>';
    // ИСПРАВЛЕНИЕ: Данные из базы вставляются корректно в переменную
    const savedMatchData = <%- locals.savedData ? JSON.stringify(savedData) : 'null' %>;
    
    let charsData = {}, myRole = 'spectator', myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
    sessionStorage.setItem('draft_user_id', myUserId);

    // Подключаем сокет только если это активная игра
    const socket = io({ transports: ['websocket'], autoConnect: !savedMatchData });

    window.onload = async () => {
        // Загружаем данные персонажей
        const response = await fetch('/characters.json');
        charsData = await response.json();
        
        renderRows();

        if (savedMatchData) {
            console.log("Загружена игра из истории");
            renderHistoryGame(savedMatchData);
        } else {
            // Обычная логика подключения для новой игры
            socket.connect();
            socket.emit('rejoin_game', { roomId: currentRoom, userId: myUserId });
        }
    };

    function renderHistoryGame(data) {
        document.getElementById('status').innerText = "DRAFT COMPLETED (HISTORY)";
        document.getElementById('blue-name-display').innerText = data.blueName;
        document.getElementById('red-name-display').innerText = data.redName;
        document.getElementById('blue-ready-switch').style.display = 'none';
        document.getElementById('red-ready-switch').style.display = 'none';
        document.querySelector('.controls-area').style.display = 'none';
        document.getElementById('char-pool-container').style.opacity = '0.3';

        // Создаем состояние для функции отрисовки
        const fakeState = {
            bluePicks: data.bluePicks,
            redPicks: data.redPicks,
            bans: data.bans,
            draftType: data.draftType,
            gameStarted: true,
            immunityPhaseActive: false,
            stepIndex: 100,
            ready: { blue: true, red: true }
        };
        renderSlots(fakeState);
    }

    // --- Оставшиеся функции (updateUI, renderSlots, и т.д.) остаются такими же как были ---
    socket.on('init_game', (data) => {
        myRole = data.role;
        updateUI(data.state);
    });

    socket.on('update_state', updateUI);
    socket.on('timer_tick', (data) => { /* логика таймера */ });
    
    // Вставь сюда все остальные функции: toggleReady, renderRows, createChar, confirmSelection, updateUI и т.д.
</script>

<%- include('../partials/footer') %>
