<script>
    const socket = io({ transports: ['websocket'] });
    const currentRoom = '<%= roomId %>';
    const myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
    sessionStorage.setItem('draft_user_id', myUserId);
    let myRole = '', currentDraftType = 'gitcg';
    let charsData = {}, selectedCharId = null, isGameStarted = false, activeTeam = 'blue';

    socket.on('connect', () => {
        if (currentRoom && myUserId) {
            const nick = sessionStorage.getItem('draft_nickname') || 'Player';
            const isSpectator = sessionStorage.getItem('join_as_spectator') === 'true';

            socket.emit('join_game', { 
                roomId: currentRoom, 
                nickname: nick, 
                userId: myUserId,
                asSpectator: isSpectator 
            });
        }
    });

    socket.on('error_msg', (msg) => {
        if (msg === 'Session expired' || msg === 'Room not found') {
            alert("Сессия игры не найдена или истекла.");
            window.location.href = "/"; 
        } else {
            alert(msg);
        }
    });

    socket.on('init_game', (data) => {
        myRole = data.role; 
        charsData = data.chars;
        currentDraftType = data.state.draftType || 'gitcg';
        
        document.getElementById('room-display').innerText = `CODE: ${currentRoom}` + (myRole === 'spectator' ? " (SPEC)" : "");
        renderRows(); 
        updateUI(data.state);
    });

    socket.on('update_state', updateUI);
    socket.on('game_started', () => { isGameStarted = true; });
    socket.on('game_over', (state) => { 
        updateUI(state); 
        setTimeout(() => alert("Draft Completed!"), 500); 
    });

    socket.on('timer_tick', (data) => {
        const t = typeof data === 'object' ? data.main : data;
        const b = document.getElementById('blue-timer'), r = document.getElementById('red-timer');
        if(activeTeam==='blue') { b.innerText=t; r.innerText="45"; b.style.color=t<10?'#ff5555':'#4facfe'; }
        else { r.innerText=t; b.innerText="45"; r.style.color=t<10?'#ff5555':'#ff6b6b'; }
        if(typeof data === 'object') {
            document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
            document.getElementById('red-res').innerText = formatTime(data.redReserve);
        }
    });

    function formatTime(s) { 
        if (s < 0) s = 0;
        const m=Math.floor(s/60), sec=s%60; 
        return `${m}:${sec<10?'0':''}${sec}`; 
    }

    function toggleReady(r) { if(myRole===r) socket.emit('player_ready', currentRoom); }
    
    function copyRoomCode() { 
        if (!currentRoom) return;
        navigator.clipboard.writeText(currentRoom).then(() => {
            const toast = document.getElementById('copy-toast');
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2000);
        });
    }
    
    function skipTurn() {
        if(currentRoom) socket.emit('skip_action', currentRoom);
    }
    
    function renderRows() {
        const container = document.getElementById('char-pool-container');
        container.innerHTML = '';
        const ladder = document.createElement('div'); ladder.className = 'ladder-container';
        const schema = DRAFT_RULES[currentDraftType];
        if(schema) {
            schema.forEach((step, i) => {
                const d = document.createElement('div');
                const sideClass = step.team === 'blue' ? 'step-left' : 'step-right';
                let colorClass = 'step-pick'; 
                
                if (step.type.includes('ban')) { colorClass = 'step-ban'; } 
                else if (step.type.includes('immunity')) { colorClass = 'step-immunity'; }
                
                d.className = `ladder-step ${sideClass} ${colorClass}`;
                d.id = `step-node-${i}`; d.innerText = `${i+1}. ${step.type.replace('immunity_', 'IM ')}`;
                ladder.appendChild(d);
            });
            container.appendChild(ladder);
        }

        ['cryo','hydro','pyro','electro','anemo','geo','dendro'].forEach(elem => {
            const row = document.createElement('div'); row.className = `element-row row-${elem}`;
            const chars = charsData[elem], mid = Math.ceil(chars.length/2);
            const l = document.createElement('div'); l.className = 'row-half left-half';
            chars.slice(0,mid).forEach(c => l.appendChild(createChar(c)));
            const gap = document.createElement('div'); gap.className = 'row-gap';
            const r = document.createElement('div'); r.className = 'row-half right-half';
            chars.slice(mid).forEach(c => r.appendChild(createChar(c)));
            row.appendChild(l); row.appendChild(gap); row.appendChild(r);
            container.appendChild(row);
        });
    }

    function createChar(char) {
        const el = document.createElement('div');
        el.className = 'char-option'; el.id = `char-${char.id}`;
        el.innerHTML = `<img src="${char.img}">`;
        el.onclick = () => {
            if(!isGameStarted || myRole === 'spectator') return;
            document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
            selectedCharId = char.id; el.classList.add('selected-pending');
            document.getElementById('confirm-btn').disabled = false;
        };
        return el;
    }

    function confirmSelection() {
        if(selectedCharId && currentRoom) {
            socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
            selectedCharId = null; document.getElementById('confirm-btn').disabled = true;
            document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
        }
    }

    function updateImmunityTop(state) {
        const topDisp = document.getElementById('immunity-top-display');
        if(state.draftType !== 'gitcg_cup_2') { topDisp.style.display = 'none'; return; }
        topDisp.style.display = 'flex';
        const row = document.getElementById('immunity-icons-row');
        row.innerHTML = '';
        
        const iBans = state.immunityBans || [];
        const iPicks = state.immunitySelections || [];
        
        const bBan = iBans.find(x => x.team === 'blue');
        const rBan = iBans.find(x => x.team === 'red');
        const bPick = iPicks.find(x => x.team === 'blue');
        const rPick = iPicks.find(x => x.team === 'red');

        const slots = [ 
            { val: bBan?.id, type: 'ban', team: 'blue' }, 
            { val: rBan?.id, type: 'ban', team: 'red' }, 
            { val: bPick?.id, type: 'pick', team: 'blue' }, 
            { val: rPick?.id, type: 'pick', team: 'red' } 
        ];

        slots.forEach(slot => {
            const div = document.createElement('div');
            div.className = `im-icon im-${slot.type}`;
            if (slot.val === 'skipped') {
                div.innerHTML = `<span style="color:#aaa; font-size:20px; line-height:36px; display:block; text-align:center;">✖</span>`;
                div.style.background = '#222';
            } else if (slot.val) {
                let all = []; Object.values(charsData).forEach(a => all.push(...a));
                const char = all.find(c => c.id === slot.val);
                if(char) div.innerHTML = `<img src="${char.img}">`;
            } else div.classList.add('im-empty');
            row.appendChild(div);
        });
    }

    function updateUI(state) {
        isGameStarted = state.gameStarted;
        activeTeam = state.currentTeam;
        document.getElementById('blue-ready-switch').style.display = state.gameStarted?'none':'flex';
        document.getElementById('red-ready-switch').style.display = state.gameStarted?'none':'flex';
        if(!state.gameStarted) {
            state.ready.blue ?
            document.getElementById('blue-ready-switch').classList.add('ready-on') : document.getElementById('blue-ready-switch').classList.remove('ready-on');
            state.ready.red ? document.getElementById('red-ready-switch').classList.add('ready-on') : document.getElementById('red-ready-switch').classList.remove('ready-on');
        }
        document.getElementById('blue-name-display').innerText = state.blueName;
        document.getElementById('red-name-display').innerText = state.redName;
        
        let txt = "WAITING...";
        // --- ИСПРАВЛЕНИЕ: Добавлена проверка state.currentAction ---
        if(state.immunityPhaseActive && state.currentAction) {
            const niceAction = state.currentAction.replace('immunity_', '').toUpperCase();
            txt = `IMMUNITY: ${state.currentTeam} ${niceAction}`;
        }
        else if(state.gameStarted) txt = `${state.currentTeam} IS ${state.currentAction==='ban'?'BANNING':'PICKING'}`;
        document.getElementById('status').innerText = txt.toUpperCase();

        updateImmunityTop(state);

        const skipBtn = document.getElementById('skip-btn');
        const isMyTurn = (myRole === state.currentTeam);
        
        skipBtn.classList.remove('skip-left', 'skip-right');
        if (state.immunityPhaseActive && isMyTurn) {
            skipBtn.style.display = 'block';
            if (state.currentTeam === 'blue') skipBtn.classList.add('skip-left');
            else skipBtn.classList.add('skip-right');
        } else {
            skipBtn.style.display = 'none';
        }

        const idx = state.stepIndex - 1;
        const currentSchema = DRAFT_RULES[currentDraftType];
        if(!state.immunityPhaseActive && currentSchema) {
            const len = currentSchema.length;
            for(let i=0; i<len; i++) {
                const n = document.getElementById(`step-node-${i}`);
                if(!n) continue;
                n.classList.remove('step-active','step-done');
                if(i < idx) n.classList.add('step-done');
                else if(i === idx && state.gameStarted) {
                    n.classList.add('step-active');
                    setTimeout(() => n.scrollIntoView({behavior:'smooth', block:'center'}), 50);
                }
            }
        }

        renderSlots(state);

        // --- ЛОГИКА БЛОКИРОВКИ (DISABLED) ---
        document.querySelectorAll('.char-option').forEach(el => el.classList.remove('disabled', 'immunity-highlight'));

        state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
        [...state.bluePicks, ...state.redPicks].forEach(id => document.getElementById(`char-${id}`)?.classList.add('disabled'));

        if (currentDraftType === 'gitcg_cup_2') {
            const imBans = state.immunityBans || [];
            const imPicks = state.immunitySelections || [];

            if (state.immunityPhaseActive) {
                [...imBans, ...imPicks].forEach(item => {
                    document.getElementById(`char-${item.id}`)?.classList.add('disabled');
                });
            } else {
                imPicks.forEach(item => {
                    document.getElementById(`char-${item.id}`)?.classList.add('disabled');
                });

                if (state.currentAction === 'pick' && activeTeam === myRole) {
                    const myPickCount = activeTeam === 'blue' ? state.bluePicks.length : state.redPicks.length;
                    const currentPickNum = myPickCount + 1;

                    if (currentPickNum === 4 || currentPickNum === 9) {
                        const myImmune = imPicks.find(i => i.team === activeTeam);
                        if (myImmune && !(activeTeam === 'blue' ? state.bluePicks : state.redPicks).includes(myImmune.id)) {
                            const el = document.getElementById(`char-${myImmune.id}`);
                            if (el) {
                                el.classList.remove('disabled');
                                el.classList.add('immunity-highlight');
                            }
                        }
                    }
                }
            }
        }

        if(state.gameStarted && myRole !== 'spectator' && myRole !== state.currentTeam) {
            document.querySelectorAll('.char-option').forEach(el => el.classList.add('disabled'));
        }
    }

    function getStepsFor(schema, team, type) {
        if (!schema) return [];
        let startIndex = 0;
        if (currentDraftType === 'gitcg_cup_2') startIndex = 4;

        return schema
            .map((step, index) => ({ ...step, globalIndex: index + 1 }))
            .slice(startIndex) 
            .filter(step => step.team === team && step.type === type)
            .map(step => ({ num: step.globalIndex, immunity: false })); 
    }

    function renderSlots(state) {
        const currentSchema = DRAFT_RULES[currentDraftType];
        if (!currentSchema) return;

        const blueBanSteps = getStepsFor(currentSchema, 'blue', 'ban');
        const redBanSteps = getStepsFor(currentSchema, 'red', 'ban');
        const bluePickSteps = getStepsFor(currentSchema, 'blue', 'pick');
        const redPickSteps = getStepsFor(currentSchema, 'red', 'pick');

        const fill = (containerId, items, stepData, isBan) => {
            const div = document.getElementById(containerId);
            if(!div) return;
            div.innerHTML = ''; 
            stepData.forEach((step, i) => {
                const slot = document.createElement('div');
                slot.className = 'slot-circle';
                if (isBan) slot.classList.add('slot-ban');
                
                if (!state.immunityPhaseActive && state.gameStarted && step.num === state.stepIndex) {
                    slot.classList.add('active-slot');
                }

                let charId = null;
                if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];

                if (charId) {
                    let allFlat = []; Object.values(charsData).forEach(arr => allFlat.push(...arr));
                    const char = allFlat.find(c => c.id === charId);
                    if (char) slot.innerHTML = `<img src="${char.img}">`;
                } else slot.innerHTML = `<span class="step-number">${step.num}</span>`; 
                div.appendChild(slot);
            });
        };

        fill('blue-bans', state.bans.filter(b => b.team === 'blue'), blueBanSteps, true);
        fill('red-bans', state.bans.filter(b => b.team === 'red'), redBanSteps, true);

        if (currentDraftType === 'generals_2' || currentDraftType === 'classic') {
            fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
            fill('blue-picks-2', [], [], false); 
            fill('red-picks-1', state.redPicks, redPickSteps, false);
            fill('red-picks-2', [], [], false);
        } else {
            fill('blue-picks-1', state.bluePicks.slice(0, 5), bluePickSteps.slice(0, 5), false);
            fill('blue-picks-2', state.bluePicks.slice(5, 9), bluePickSteps.slice(5, 9), false);
            fill('red-picks-1', state.redPicks.slice(0, 5), redPickSteps.slice(0, 5), false);
            fill('red-picks-2', state.redPicks.slice(5, 9), redPickSteps.slice(5, 9), false);
        }
    }
</script>
