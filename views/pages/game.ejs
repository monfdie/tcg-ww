<%- include('../partials/header') %>

<style>
    .page-container { padding: 0 !important; max-width: 100% !important; height: 100%; display: flex; flex-direction: column; }
    .player-header { height: auto !important; min-height: 70px; }
    .player-info-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
    .player-avatar { width: 54px; height: 54px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 12px rgba(0,0,0,0.6); display: none; }
    
    .deck-builder-panel { display: none; flex-grow: 1; background: rgba(10, 12, 20, 0.95); border-top: 2px solid #3c4566; padding: 20px; flex-direction: column; align-items: center; overflow-y: auto; }
    .builder-header { display: flex; justify-content: center; position: relative; width: 100%; max-width: 1000px; margin-bottom: 20px; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; min-height: 50px; }
    
    .match-score { font-family: 'Cinzel', serif; font-size: 2.5em; color: #fff; text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); letter-spacing: 5px; }

    .winner-controls { display: flex; align-items: center; gap: 15px; min-width: 150px; justify-content: center; }
    .win-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; background: transparent; color: #555; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; transition: 0.2s; font-size: 1.2em; }
    .win-btn:hover { border-color: #aaa; color: #aaa; }
    .win-btn.active-blue { background: #4facfe; border-color: #4facfe; color: #000; box-shadow: 0 0 15px #4facfe; }
    .win-btn.active-red { background: #ff6b6b; border-color: #ff6b6b; color: #000; box-shadow: 0 0 15px #ff6b6b; }
    .vs-text { font-family: 'Cinzel', serif; color: #666; font-size: 1.2em; }

    .save-match-btn { position: absolute; right: 0; top: 5px; background: #d4af37; color: #000; font-weight: bold; border: none; padding: 12px 30px; border-radius: 4px; font-family: 'Cinzel', serif; cursor: pointer; transition: 0.2s; }
    .save-match-btn:hover { box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); transform: scale(1.05); }

    .games-grid { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 1100px; }
    .game-row { display: flex; align-items: center; justify-content: center; gap: 30px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid #2a3454; animation: fadeIn 0.5s ease; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .deck-slots-group { display: flex; gap: 10px; }
    .deck-slot { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #3c4566; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; }
    .deck-slot:hover { border-color: #4facfe; transform: scale(1.05); }
    .deck-slot img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    
    #char-select-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; }
    .select-box { background: #161c30; border: 1px solid #4facfe; padding: 20px; border-radius: 8px; width: 600px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    
    .select-char-item { width: 70px; height: 70px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; background: rgba(20, 25, 40, 0.8); position: relative; overflow: hidden; }
    .select-char-item:hover { border-color: #4facfe; transform: scale(1.1); }
    .select-char-item img { width: 100%; height: 100%; object-fit: cover; }

    /* ОСОБОЕ ПРАВИЛО: Делаем серым ТОЛЬКО КАРТИНКУ, чтобы желтая рамка не теряла цвет */
    #char-pool-container .char-option.disabled {
        pointer-events: none !important;
        opacity: 0.5;
        filter: none !important; /* Убираем стандартный глобальный фильтр */
    }
    #char-pool-container .char-option.disabled img {
        filter: grayscale(100%);
    }

    /* Подсветка иммунных */
    #char-pool-container .char-option.immunity-highlight { 
        border: 3px solid #d4af37 !important; 
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.8) !important; 
    }
    
    /* Если иммунитет заблокирован - оставляем картинку полуцветной, рамка остается золотой */
    #char-pool-container .char-option.disabled.immunity-highlight {
        opacity: 0.8 !important; 
    }
    #char-pool-container .char-option.disabled.immunity-highlight img {
        filter: grayscale(70%);
    }

    .turn-timer { transition: opacity 0.3s ease; }
</style>

<div id="game-screen">
    <div class="game-header">
         <div id="room-container">
             <div id="room-display" onclick="copyRoomCode()">CODE: <%= roomId %></div>
             <span id="copy-toast">Code Copied!</span>
         </div>
         <div class="reserve-timer blue-res"><span id="blue-res">3:00</span></div>
         <div id="status">Waiting...</div>
         <div class="reserve-timer red-res"><span id="red-res">3:00</span></div>
    </div>

     <div class="draft-area">
         <div id="immunity-top-display" class="immunity-top-container" style="display: none;">
             <div class="im-label">IMMUNE</div>
             <div class="im-row" id="immunity-icons-row"></div>
         </div>
         <div class="team-side blue-side">
             <div class="player-header">
                 <div id="blue-timer" class="turn-timer">45</div>
                 <div class="player-info-wrapper">
                     <img id="blue-avatar" class="player-avatar" src="" alt="">
                     <h2 id="blue-name-display">PLAYER 1</h2>
                 </div>
                 <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                     <div class="switch-circle"></div>
                 </div>
             </div>
             <div class="ban-row" id="blue-bans"></div>
             <div class="pick-row" id="blue-picks-1"></div>
             <div class="pick-row-small" id="blue-picks-2"></div>
         </div>
         <div class="center-axis">
             <div class="mid-label ban-label">BANS</div>
             <div class="mid-label pick-label">PICKS</div>
         </div>
         <div class="team-side red-side">
             <div class="player-header">
                 <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                     <div class="switch-circle"></div>
                 </div>
                 <div class="player-info-wrapper">
                     <img id="red-avatar" class="player-avatar" src="" alt="">
                     <h2 id="red-name-display">PLAYER 2</h2>
                 </div>
                 <div id="red-timer" class="turn-timer">45</div>
             </div>
             <div class="ban-row" id="red-bans"></div>
             <div class="pick-row" id="red-picks-1"></div>
             <div class="pick-row-small" id="red-picks-2"></div>
         </div>
     </div>

     <div class="controls-area" style="min-height: 40px;">
         <button id="skip-btn" class="round-btn" onclick="skipTurn()" style="display: none;">SKIP</button>
         <button id="confirm-btn" class="confirm-btn round-btn" onclick="confirmSelection()" disabled style="display: none;">SELECT</button>
     </div>

     <div class="char-pool" id="char-pool-container"></div>

     <div class="deck-builder-panel" id="deck-builder-panel">
         <div class="builder-header">
             <div id="score-display" class="match-score">0 - 0</div>
             <button class="save-match-btn" id="finish-btn" onclick="finishMatch()">FINISH</button>
         </div>
         <div class="games-grid" id="games-grid"></div>
     </div>
</div>

<div id="char-select-modal" onclick="closeSelectModal(event)">
    <div class="select-box" id="select-box-content"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/draft-rules.js"></script>

<script>
    const socket = io({ transports: ['websocket'] });
    const currentRoom = '<%= roomId %>';
    const myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
    sessionStorage.setItem('draft_user_id', myUserId);
    
    let myRole = '', currentDraftType = 'gitcg', isGameStarted = false;
    let charsData = {}, selectedCharId = null;
    
    const myRealDiscordId = '<%= locals.user ? locals.user.discordId : "" %>';
    const myAvatarHash = '<%= locals.user ? locals.user.avatar : "" %>';
    const myNick = <%- locals.user ? JSON.stringify(locals.user.username) : '""' %>; 

    const savedData = <%- JSON.stringify(locals.savedData || null) %>;
    const serverChars = <%- JSON.stringify(locals.chars || null) %>;

    let currentSlotIndex = null;
    let myPicksList = [];

    if (savedData) {
        socket.disconnect(); charsData = serverChars;
        renderRows(); 
        const mockState = {
            gameStarted: true, currentTeam: 'none', currentAction: 'none',
            bans: savedData.bans, bluePicks: savedData.bluePicks, redPicks: savedData.redPicks,
            blueName: savedData.blueName, redName: savedData.redName,
            blueDiscordId: savedData.blueDiscordId, redDiscordId: savedData.redDiscordId,
            blueAvatar: savedData.blueAvatar, redAvatar: savedData.redAvatar,
            draftType: savedData.draftType, immunityPhaseActive: false,
            immunityPool: savedData.immunityPool||[], immunityBans: savedData.immunityBans||[],
            stepIndex: 999, ready: { blue: true, red: true },
            draftFinished: true, blueDecks: savedData.blueDecks || [], redDecks: savedData.redDecks || [],
            gameResults: savedData.gameResults || [null,null,null], matchSaved: true
        };
        updateUI(mockState);
    } else {
        socket.on('connect', () => {
            if (currentRoom && myUserId) {
                socket.emit('rejoin_game', { 
                    roomId: currentRoom, userId: myUserId, 
                    discordId: myRealDiscordId, avatar: myAvatarHash, nickname: myNick 
                });
            }
        });
        socket.on('init_game', (data) => {
            myRole = data.role; charsData = data.chars; currentDraftType = data.state.draftType || 'gitcg';
            document.getElementById('room-display').innerText = `CODE: ${currentRoom}` + (myRole === 'spectator' ? " (SPEC)" : "");
            renderRows(); updateUI(data.state);
        });
        socket.on('update_state', updateUI);
        socket.on('game_started', () => { isGameStarted = true; });
        socket.on('game_over', (state) => { updateUI(state); });
        
        socket.on('timer_tick', (data) => {
            const t = typeof data === 'object' ? data.main : data;
            document.getElementById('blue-timer').innerText = t; 
            document.getElementById('red-timer').innerText = t;
            if(typeof data === 'object') {
                 document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
                 document.getElementById('red-res').innerText = formatTime(data.redReserve);
            }
        });
        socket.on('match_saved_success', () => { alert("Match Saved!"); window.location.href = '/'; });
    }

    function formatTime(s) { if (s < 0) s = 0; const m=Math.floor(s/60), sec=s%60; return `${m}:${sec<10?'0':''}${sec}`; }
    function toggleReady(r) { if(myRole===r) socket.emit('player_ready', currentRoom); }
    function copyRoomCode() { navigator.clipboard.writeText(currentRoom); }
    function skipTurn() { if(currentRoom && !savedData) socket.emit('skip_action', currentRoom); }
    
    function updateUI(state) {
        if (state.draftFinished) {
            document.getElementById('char-pool-container').style.display = 'none';
            document.getElementById('deck-builder-panel').style.display = 'flex';
            document.getElementById('confirm-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            document.getElementById('status').innerText = "SETUP PHASE";
            if (state.matchSaved) document.getElementById('finish-btn').style.display = 'none';
            renderDeckBuilder(state);
        } else {
            document.getElementById('char-pool-container').style.display = 'flex';
            document.getElementById('deck-builder-panel').style.display = 'none';
        }

        isGameStarted = state.gameStarted; 
        const isMyTurn = (myRole === state.currentTeam);

        if (!state.gameStarted || state.draftFinished) {
             document.getElementById('blue-timer').style.opacity = '0';
             document.getElementById('red-timer').style.opacity = '0';
        } else {
             document.getElementById('blue-timer').style.opacity = (state.currentTeam === 'blue') ? '1' : '0';
             document.getElementById('red-timer').style.opacity = (state.currentTeam === 'red') ? '1' : '0';
        }

        document.querySelectorAll('.ladder-step').forEach((el, idx) => {
            el.classList.remove('step-active', 'step-done');
            if (idx < state.stepIndex - 1) {
                el.classList.add('step-done');
            } else if (idx === state.stepIndex - 1 && state.gameStarted && !state.draftFinished && !state.immunityPhaseActive) {
                el.classList.add('step-active');
            }
        });

        const confirmBtn = document.getElementById('confirm-btn');
        const skipBtn = document.getElementById('skip-btn');

        if (state.gameStarted && !state.draftFinished && !savedData && isMyTurn) {
            confirmBtn.style.display = 'inline-block';
            if (state.immunityPhaseActive) {
                skipBtn.style.display = 'inline-block';
                skipBtn.className = (state.currentTeam === 'blue') ? 'round-btn skip-left' : 'round-btn skip-right';
            } else {
                skipBtn.style.display = 'none';
            }
        } else {
            confirmBtn.style.display = 'none';
            skipBtn.style.display = 'none';
        }

        document.getElementById('blue-ready-switch').style.display = state.gameStarted?'none':'flex';
        document.getElementById('red-ready-switch').style.display = state.gameStarted?'none':'flex';
        if(!state.gameStarted) {
             state.ready.blue ? document.getElementById('blue-ready-switch').classList.add('ready-on') : document.getElementById('blue-ready-switch').classList.remove('ready-on');
             state.ready.red ? document.getElementById('red-ready-switch').classList.add('ready-on') : document.getElementById('red-ready-switch').classList.remove('ready-on');
        }

        document.getElementById('blue-name-display').innerText = state.blueName;
        document.getElementById('red-name-display').innerText = state.redName;
        const blueAv = document.getElementById('blue-avatar');
        if (state.blueAvatar && state.blueDiscordId) { blueAv.src = `https://cdn.discordapp.com/avatars/${state.blueDiscordId}/${state.blueAvatar}.png`; blueAv.style.display = 'block'; }
        const redAv = document.getElementById('red-avatar');
        if (state.redAvatar && state.redDiscordId) { redAv.src = `https://cdn.discordapp.com/avatars/${state.redDiscordId}/${state.redAvatar}.png`; redAv.style.display = 'block'; }
        
        let txt = "WAITING...";
        if(state.immunityPhaseActive) txt = `IMMUNITY: ${state.currentTeam} ${state.currentAction}`;
        else if(state.gameStarted) txt = `${state.currentTeam} IS ${state.currentAction==='ban'?'BANNING':'PICKING'}`;
        if (state.draftFinished) txt = "MATCH SETUP / PLAYING";
        if (state.matchSaved) txt = "MATCH FINISHED";
        document.getElementById('status').innerText = txt.toUpperCase();

        updateImmunityTop(state);
        renderSlots(state);
        
        // --- ЛОГИКА БЛОКИРОВОК ---
        document.querySelectorAll('.char-option').forEach(el => el.classList.remove('disabled', 'immunity-highlight'));
        
        const immuneChars = state.immunityPool ? state.immunityPool.filter(id => id !== 'skipped') : [];
        const immunityBans = state.immunityBans ? state.immunityBans.filter(id => id !== 'skipped') : [];

        if (state.immunityPhaseActive) {
            // ФАЗА ИММУНИТЕТА
            immuneChars.forEach(id => {
                const el = document.getElementById(`char-${id}`);
                if(el) el.classList.add('immunity-highlight', 'disabled');
            });

            immunityBans.forEach(id => {
                document.getElementById(`char-${id}`)?.classList.add('disabled');
            });
            
        } else if (state.gameStarted && !state.draftFinished) {
            // ОБЫЧНЫЙ ДРАФТ
            
            const currentStepData = DRAFT_RULES[state.draftType][state.stepIndex - 1] || {};
            const isImmuneStep = currentStepData.immunity === true;
            
            // 1. Обычные баны - заблокированы всегда
            state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));

            // 2. Иммунные баны (красные) БОЛЬШЕ НЕ БЛОКИРУЮТСЯ ЗДЕСЬ! Их можно брать.

            // 3. Обработка Иммунных пиков (золотых)
            if (state.currentAction && state.currentAction.includes('ban')) {
                // Стадия обычного БАНА: Иммунных банить нельзя, они становятся недоступными
                immuneChars.forEach(id => {
                    document.getElementById(`char-${id}`)?.classList.add('disabled');
                });
            } else {
                // Стадия обычного ПИКА
                if (!isImmuneStep) {
                    // Это НЕ иммунный слот (не 4 или 9 пик), значит иммунных брать нельзя
                    immuneChars.forEach(id => {
                        document.getElementById(`char-${id}`)?.classList.add('disabled');
                    });
                }
                // Если isImmuneStep === true, мы НЕ добавляем им класс disabled, они доступны!
            }

            // Золотая рамка для иммунных вешается в любом случае
            immuneChars.forEach(id => {
                 const el = document.getElementById(`char-${id}`);
                 if(el) el.classList.add('immunity-highlight');
            });

            // 4. Обычные пики (нельзя взять то, что уже взял ты сам, или то, что взял враг)
            state.bluePicks.forEach(id => {
                if (myRole === 'blue') {
                    document.getElementById(`char-${id}`)?.classList.add('disabled'); // Я уже взял
                } else if (myRole === 'red') {
                    if (!immuneChars.includes(id)) document.getElementById(`char-${id}`)?.classList.add('disabled'); // Враг взял
                } else {
                    if (!immuneChars.includes(id)) document.getElementById(`char-${id}`)?.classList.add('disabled'); // Спектатор
                }
            });

            state.redPicks.forEach(id => {
                if (myRole === 'red') {
                    document.getElementById(`char-${id}`)?.classList.add('disabled');
                } else if (myRole === 'blue') {
                    if (!immuneChars.includes(id)) document.getElementById(`char-${id}`)?.classList.add('disabled');
                } else {
                    if (!immuneChars.includes(id)) document.getElementById(`char-${id}`)?.classList.add('disabled');
                }
            });
        }
    }

    function renderDeckBuilder(state) {
        let blueScore = 0, redScore = 0;
        state.gameResults.forEach(r => { if(r === 'blue') blueScore++; if(r === 'red') redScore++; });
        document.getElementById('score-display').innerText = `${blueScore} - ${redScore}`;

        if (myRole === 'blue') myPicksList = state.bluePicks;
        if (myRole === 'red') myPicksList = state.redPicks;

        const grid = document.getElementById('games-grid');
        grid.innerHTML = '';

        let showThirdGame = false;
        if (state.gameResults[0] && state.gameResults[1] && state.gameResults[0] !== state.gameResults[1]) showThirdGame = true;

        for (let i = 0; i < 3; i++) {
            if (i === 2 && !showThirdGame) continue;
            const row = document.createElement('div'); row.className = 'game-row';

            const blueGroup = document.createElement('div'); blueGroup.className = 'deck-slots-group';
            for (let j=0; j<3; j++) { blueGroup.appendChild(createDeckSlot(state.blueDecks[i*3 + j], i*3 + j, 'blue')); }

            const controls = document.createElement('div'); controls.className = 'winner-controls';
            
            const btnBlue = document.createElement('button'); btnBlue.className = `win-btn ${state.gameResults[i] === 'blue' ? 'active-blue' : ''}`;
            btnBlue.innerText = 'W'; btnBlue.onclick = () => setWinner(i, 'blue');

            const vsText = document.createElement('span'); vsText.className = 'vs-text'; vsText.innerText = 'VS';

            const btnRed = document.createElement('button'); btnRed.className = `win-btn ${state.gameResults[i] === 'red' ? 'active-red' : ''}`;
            btnRed.innerText = 'W'; btnRed.onclick = () => setWinner(i, 'red');

            controls.appendChild(btnBlue); controls.appendChild(vsText); controls.appendChild(btnRed);

            const redGroup = document.createElement('div'); redGroup.className = 'deck-slots-group';
            for (let j=0; j<3; j++) { redGroup.appendChild(createDeckSlot(state.redDecks[i*3 + j], i*3 + j, 'red')); }

            row.appendChild(blueGroup); row.appendChild(controls); row.appendChild(redGroup); grid.appendChild(row);
        }
    }

    function createDeckSlot(charId, index, team) {
        const slot = document.createElement('div'); slot.className = 'deck-slot';
        if (charId) {
            let all = []; Object.values(charsData).forEach(a => all.push(...a));
            const c = all.find(x => x.id === charId);
            if (c) slot.innerHTML = `<img src="${c.img}">`;
        }
        if (!savedData && myRole === team) slot.onclick = () => openCharSelector(index);
        return slot;
    }

    function setWinner(gameIdx, winner) { if (!savedData) socket.emit('update_game_winner', { roomId: currentRoom, gameIndex: gameIdx, winner: winner }); }

    function openCharSelector(idx) {
        currentSlotIndex = idx;
        const box = document.getElementById('select-box-content'); box.innerHTML = '';
        let all = []; Object.values(charsData).forEach(a => all.push(...a));
        const myChars = all.filter(c => myPicksList.includes(c.id));
        const clr = document.createElement('div'); clr.className = 'select-char-item';
        clr.style.border = '1px dashed #3c4566'; clr.innerHTML = '<span style="color:#aaa; position:absolute; top:35%; left:15%;">CLEAR</span>';
        clr.onclick = () => selectDeckChar(null); box.appendChild(clr);
        myChars.forEach(c => {
            const d = document.createElement('div'); d.className = 'select-char-item'; d.innerHTML = `<img src="${c.img}">`;
            d.onclick = () => selectDeckChar(c.id); box.appendChild(d);
        });
        document.getElementById('char-select-modal').style.display = 'flex';
    }

    function selectDeckChar(charId) { socket.emit('update_deck_slot', { roomId: currentRoom, slotIndex: currentSlotIndex, charId: charId }); document.getElementById('char-select-modal').style.display = 'none'; }
    function closeSelectModal(e) { if(e.target.id === 'char-select-modal') document.getElementById('char-select-modal').style.display = 'none'; }
    function finishMatch() { if(confirm("Save results and finish match?")) { document.getElementById('finish-btn').style.display = 'none'; socket.emit('finish_match_setup', { roomId: currentRoom }); } }

    function renderRows() {
        const container = document.getElementById('char-pool-container'); container.innerHTML = '';
        const ladder = document.createElement('div'); ladder.className = 'ladder-container';
        const schema = DRAFT_RULES[currentDraftType];
        if(schema) {
            schema.forEach((step, i) => {
                const d = document.createElement('div');
                const sideClass = step.team === 'blue' ? 'step-left' : 'step-right';
                let colorClass = 'step-pick'; 
                if (step.type.includes('ban')) { colorClass = 'step-ban'; } else if (step.immunity) { colorClass = 'step-immunity'; }
                d.className = `ladder-step ${sideClass} ${colorClass}`;
                d.id = `step-node-${i}`; d.innerText = `${i+1}. ${step.type}`;
                ladder.appendChild(d);
            });
            container.appendChild(ladder);
        }
        ['cryo','hydro','pyro','electro','anemo','geo','dendro'].forEach(elem => {
            const row = document.createElement('div'); row.className = `element-row row-${elem}`;
            const chars = charsData[elem], mid = Math.ceil(chars.length/2);
            if(!chars) return; 
            const l = document.createElement('div'); l.className = 'row-half left-half';
            chars.slice(0,mid).forEach(c => l.appendChild(createChar(c)));
            const gap = document.createElement('div'); gap.className = 'row-gap';
            const r = document.createElement('div'); r.className = 'row-half right-half';
            chars.slice(mid).forEach(c => r.appendChild(createChar(c)));
            row.appendChild(l); row.appendChild(gap); row.appendChild(r);
            container.appendChild(row);
        });
    }
    function createChar(char) {
        const el = document.createElement('div'); el.className = 'char-option'; el.id = `char-${char.id}`;
        el.innerHTML = `<img src="${char.img}">`;
        el.onclick = () => {
            if(!isGameStarted || myRole === 'spectator' || savedData) return;
            document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
            selectedCharId = char.id; el.classList.add('selected-pending');
            document.getElementById('confirm-btn').disabled = false;
        };
        return el;
    }
    function confirmSelection() {
        if(selectedCharId && currentRoom && !savedData) {
            socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
            selectedCharId = null; document.getElementById('confirm-btn').disabled = true;
            document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
        }
    }
    function updateImmunityTop(state) {
         const topDisp = document.getElementById('immunity-top-display');
         if(state.draftType !== 'gitcg_cup_2') { topDisp.style.display = 'none'; return; }
         topDisp.style.display = 'flex';
         const row = document.getElementById('immunity-icons-row'); row.innerHTML = '';
         const bans = state.immunityBans || []; const picks = state.immunityPool || [];
         const slots = [ { val: bans[0], type: 'ban' }, { val: picks[0], type: 'pick' }, { val: picks[1], type: 'pick' }, { val: bans[1], type: 'ban' } ];
         slots.forEach(slot => {
             const div = document.createElement('div'); div.className = `im-icon im-${slot.type}`;
             if (slot.val === 'skipped') { div.innerHTML = `<span style="color:#aaa; font-size:20px; line-height:36px; display:block; text-align:center;">✖</span>`; div.style.background = '#222'; } 
             else if (slot.val) {
                 let all = []; Object.values(charsData).forEach(a => all.push(...a));
                 const char = all.find(c => c.id === slot.val);
                 if(char) div.innerHTML = `<img src="${char.img}">`;
             } else div.classList.add('im-empty');
             row.appendChild(div);
         });
    }
    function renderSlots(state) {
         const currentSchema = DRAFT_RULES[currentDraftType]; if (!currentSchema) return;
         const getStepsFor = (schema, team, type) => schema.map((step, index) => ({ ...step, globalIndex: index + 1 })).filter(step => step.team === team && step.type === type).map(step => ({ num: step.globalIndex, immunity: step.immunity }));
         const blueBanSteps = getStepsFor(currentSchema, 'blue', 'ban'); const redBanSteps = getStepsFor(currentSchema, 'red', 'ban');
         const bluePickSteps = getStepsFor(currentSchema, 'blue', 'pick'); const redPickSteps = getStepsFor(currentSchema, 'red', 'pick');
         const fill = (containerId, items, stepData, isBan) => {
             const div = document.getElementById(containerId); if(!div) return; div.innerHTML = ''; 
             stepData.forEach((step, i) => {
                 const slot = document.createElement('div'); slot.className = 'slot-circle';
                 if (isBan) slot.classList.add('slot-ban');
                 if (step.immunity) slot.classList.add('slot-immunity-pick');
                 if (!state.immunityPhaseActive && state.gameStarted && !savedData && step.num === state.stepIndex) slot.classList.add('active-slot');
                 let charId = null; if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];
                 if (charId) {
                     let allFlat = []; Object.values(charsData).forEach(arr => allFlat.push(...arr));
                     const char = allFlat.find(c => c.id === charId);
                     if (char) slot.innerHTML = `<img src="${char.img}">`;
                 } else slot.innerHTML = `<span class="step-number">${step.num}</span>`;
                 div.appendChild(slot);
             });
         };
         fill('blue-bans', state.bans.filter(b => b.team === 'blue'), blueBanSteps, true);
         fill('red-bans', state.bans.filter(b => b.team === 'red'), redBanSteps, true);
         if (currentDraftType === 'generals_2' || currentDraftType === 'classic') {
             fill('blue-picks-1', state.bluePicks, bluePickSteps, false); fill('blue-picks-2', [], [], false); 
             fill('red-picks-1', state.redPicks, redPickSteps, false); fill('red-picks-2', [], [], false);
         } else {
             fill('blue-picks-1', state.bluePicks.slice(0, 5), bluePickSteps.slice(0, 5), false);
             fill('blue-picks-2', state.bluePicks.slice(5, 9), bluePickSteps.slice(5, 9), false);
             fill('red-picks-1', state.redPicks.slice(0, 5), redPickSteps.slice(0, 5), false);
             fill('red-picks-2', state.redPicks.slice(5, 9), redPickSteps.slice(5, 9), false);
         }
    }
</script>

<%- include('../partials/footer') %>
