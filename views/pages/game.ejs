<%- include('../partials/header') %>

<style>
    .page-container {
        padding: 0 !important;
        max-width: 100% !important;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .player-info-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .player-avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        display: none;
    }
    #blue-avatar { border: 2px solid #4facfe; }
    #red-avatar { border: 2px solid #ff6b6b; }
</style>

<div id="game-screen">
    <div class="game-header">
         <div id="room-container">
             <div id="room-display" onclick="copyRoomCode()" title="Click to copy room code">CODE: <%= roomId %></div>
             <span id="copy-toast">Code Copied!</span>
         </div>
         <div class="reserve-timer blue-res"><span id="blue-res">3:00</span></div>
         <div id="status">Waiting...</div>
         <div class="reserve-timer red-res"><span id="red-res">3:00</span></div>
     </div>

     <div class="draft-area">
         <div id="immunity-top-display" class="immunity-top-container" style="display: none;">
             <div class="im-label">IMMUNE</div>
             <div class="im-row" id="immunity-icons-row"></div>
         </div>

         <div class="team-side blue-side">
             <div class="player-header">
                 <div id="blue-timer" class="turn-timer">45</div>
                 <div class="player-info-wrapper">
                     <img id="blue-avatar" class="player-avatar" src="" alt="">
                     <h2 id="blue-name-display">PLAYER 1</h2>
                 </div>
                 <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                     <div class="switch-circle"></div>
                 </div>
             </div>
             <div class="ban-row" id="blue-bans"></div>
             <div class="pick-row" id="blue-picks-1"></div>
             <div class="pick-row-small" id="blue-picks-2"></div>
         </div>

         <div class="center-axis">
             <div class="mid-label ban-label">BANS</div>
             <div class="mid-label pick-label">PICKS</div>
         </div>

         <div class="team-side red-side">
             <div class="player-header">
                 <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                     <div class="switch-circle"></div>
                 </div>
                 <div class="player-info-wrapper">
                     <img id="red-avatar" class="player-avatar" src="" alt="">
                     <h2 id="red-name-display">PLAYER 2</h2>
                 </div>
                 <div id="red-timer" class="turn-timer">45</div>
             </div>
             <div class="ban-row" id="red-bans"></div>
             <div class="pick-row" id="red-picks-1"></div>
             <div class="pick-row-small" id="red-picks-2"></div>
         </div>
     </div>

     <div class="controls-area">
         <button id="skip-btn" class="round-btn" onclick="skipTurn()">SKIP</button>
         <button id="confirm-btn" class="confirm-btn round-btn" onclick="confirmSelection()" disabled>SELECT</button>
     </div>

     <div class="char-pool" id="char-pool-container"></div>
 </div>

 <script src="/socket.io/socket.io.js"></script>
 <script src="/draft-rules.js"></script>

 <script>
     const socket = io({ transports: ['websocket'] });
     
     const currentRoom = '<%= roomId %>';
     const myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
     sessionStorage.setItem('draft_user_id', myUserId);

     let myRole = '', currentDraftType = 'gitcg';
     let charsData = {}, selectedCharId = null, isGameStarted = false, activeTeam = 'blue';
     
     const myNickname = sessionStorage.getItem('draft_nickname');
     const myRealDiscordId = '<%= locals.user ? locals.user.discordId : "" %>';
     const myAvatarHash = '<%= locals.user ? locals.user.avatar : "" %>';

     const savedData = <%- JSON.stringify(locals.savedData || null) %>;
     const serverChars = <%- JSON.stringify(locals.chars || null) %>;

     if (savedData) {
         socket.disconnect(); 
         
         charsData = serverChars;
         currentDraftType = savedData.draftType || 'gitcg';
         myRole = 'spectator';
         isGameStarted = true;

         setTimeout(() => {
             document.getElementById('room-display').innerText = `CODE: ${currentRoom} (FINISHED)`;
             document.getElementById('status').innerText = "MATCH COMPLETED";
             
             document.getElementById('blue-timer').style.display = 'none';
             document.getElementById('red-timer').style.display = 'none';
             document.querySelector('.controls-area').style.display = 'none';
             document.querySelector('.blue-res').style.display = 'none';
             document.querySelector('.red-res').style.display = 'none';

             renderRows(); 

             const mockState = {
                 gameStarted: true,
                 currentTeam: 'none',
                 currentAction: 'none',
                 bans: savedData.bans || [],
                 bluePicks: savedData.bluePicks || [],
                 redPicks: savedData.redPicks || [],
                 blueName: savedData.blueName || 'PLAYER 1',
                 redName: savedData.redName || 'PLAYER 2',
                 blueDiscordId: savedData.blueDiscordId || null,
                 redDiscordId: savedData.redDiscordId || null,
                 blueAvatar: savedData.blueAvatar || null,
                 redAvatar: savedData.redAvatar || null,
                 draftType: savedData.draftType || 'gitcg',
                 immunityPhaseActive: false,
                 immunityPool: savedData.immunityPool || [],
                 immunityBans: savedData.immunityBans || [],
                 stepIndex: 999, 
                 ready: { blue: true, red: true }
             };

             updateUI(mockState);
         }, 50);

     } else {
         socket.on('connect', () => {
             if (currentRoom && myUserId) {
                 socket.emit('rejoin_game', { 
                     roomId: currentRoom, userId: myUserId, nickname: myNickname,
                     discordId: myRealDiscordId, avatar: myAvatarHash 
                 }); 
             }
         });

         socket.on('error_msg', (msg) => {
             if (msg === 'Session expired' || msg === 'Room not found') {
                 alert("Game session expired or not found.");
                 window.location.href = "/"; 
             } else {
                 alert(msg);
             }
         });

         socket.on('init_game', (data) => {
             myRole = data.role; 
             charsData = data.chars;
             currentDraftType = data.state.draftType || 'gitcg';
             
             document.getElementById('room-display').innerText = `CODE: ${currentRoom}` + (myRole === 'spectator' ? " (SPEC)" : "");
             renderRows(); 
             updateUI(data.state);
         });

         socket.on('update_state', updateUI);
         socket.on('game_started', () => { isGameStarted = true; });
         socket.on('game_over', (state) => { 
             updateUI(state); 
             setTimeout(() => alert("Draft Completed!"), 500); 
         });
         
         socket.on('timer_tick', (data) => {
             const t = typeof data === 'object' ? data.main : data;
             const b = document.getElementById('blue-timer'), r = document.getElementById('red-timer');
             if(activeTeam==='blue') { b.innerText=t; r.innerText="45"; b.style.color=t<10?'#ff5555':'#4facfe'; }
             else { r.innerText=t; b.innerText="45"; r.style.color=t<10?'#ff5555':'#ff6b6b'; }
             if(typeof data === 'object') {
                 document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
                 document.getElementById('red-res').innerText = formatTime(data.redReserve);
             }
         });
     }

     function formatTime(s) { 
         if (s < 0) s = 0; 
         const m=Math.floor(s/60), sec=s%60; 
         return `${m}:${sec<10?'0':''}${sec}`; 
     }

     function toggleReady(r) { if(myRole===r) socket.emit('player_ready', currentRoom); }
     
     function copyRoomCode() { 
         if (!currentRoom) return;
         navigator.clipboard.writeText(currentRoom).then(() => {
             const toast = document.getElementById('copy-toast');
             toast.classList.add('show');
             setTimeout(() => { toast.classList.remove('show'); }, 2000);
         });
     }
     
     function skipTurn() {
         if(currentRoom && !savedData) {
             socket.emit('skip_action', currentRoom);
         }
     }
     
     function renderRows() {
         const container = document.getElementById('char-pool-container');
         container.innerHTML = '';
         const ladder = document.createElement('div'); ladder.className = 'ladder-container';
         const schema = DRAFT_RULES[currentDraftType];
         
         if(schema) {
             schema.forEach((step, i) => {
                 const d = document.createElement('div');
                 const sideClass = step.team === 'blue' ? 'step-left' : 'step-right';
                 let colorClass = 'step-pick'; 
                 if (step.type.includes('ban')) { colorClass = 'step-ban'; } 
                 else if (step.immunity) { colorClass = 'step-immunity'; }
                 d.className = `ladder-step ${sideClass} ${colorClass}`;
                 d.id = `step-node-${i}`; d.innerText = `${i+1}. ${step.type}`;
                 ladder.appendChild(d);
             });
             container.appendChild(ladder);
         }

         ['cryo','hydro','pyro','electro','anemo','geo','dendro'].forEach(elem => {
             const row = document.createElement('div'); row.className = `element-row row-${elem}`;
             const chars = charsData[elem], mid = Math.ceil(chars.length/2);
             if(!chars) return; 
             const l = document.createElement('div'); l.className = 'row-half left-half';
             chars.slice(0,mid).forEach(c => l.appendChild(createChar(c)));
             const gap = document.createElement('div'); gap.className = 'row-gap';
             const r = document.createElement('div'); r.className = 'row-half right-half';
             chars.slice(mid).forEach(c => r.appendChild(createChar(c)));
             row.appendChild(l); row.appendChild(gap); row.appendChild(r);
             container.appendChild(row);
         });
     }

     function createChar(char) {
         const el = document.createElement('div'); el.className = 'char-option'; el.id = `char-${char.id}`;
         el.innerHTML = `<img src="${char.img}">`;
         el.onclick = () => {
             if(!isGameStarted || myRole === 'spectator' || savedData) return;
             document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
             selectedCharId = char.id; el.classList.add('selected-pending');
             document.getElementById('confirm-btn').disabled = false;
         };
         return el;
     }

     function confirmSelection() {
         if(selectedCharId && currentRoom && !savedData) {
             socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
             selectedCharId = null; document.getElementById('confirm-btn').disabled = true;
             document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
         }
     }

     function updateImmunityTop(state) {
         const topDisp = document.getElementById('immunity-top-display');
         if(state.draftType !== 'gitcg_cup_2') { topDisp.style.display = 'none'; return; }
         topDisp.style.display = 'flex';
         const row = document.getElementById('immunity-icons-row');
         row.innerHTML = '';
         const bans = state.immunityBans || [];
         const picks = state.immunityPool || [];
         const slots = [ { val: bans[0], type: 'ban' }, { val: picks[0], type: 'pick' }, { val: picks[1], type: 'pick' }, { val: bans[1], type: 'ban' } ];
         slots.forEach(slot => {
             const div = document.createElement('div');
             div.className = `im-icon im-${slot.type}`;
             if (slot.val === 'skipped') {
                 div.innerHTML = `<span style="color:#aaa; font-size:20px; line-height:36px; display:block; text-align:center;">✖</span>`;
                 div.style.background = '#222';
             } else if (slot.val) {
                 let all = []; Object.values(charsData).forEach(a => all.push(...a));
                 const char = all.find(c => c.id === slot.val);
                 if(char) div.innerHTML = `<img src="${char.img}">`;
             } else div.classList.add('im-empty');
             row.appendChild(div);
         });
     }

     function updateUI(state) {
         isGameStarted = state.gameStarted; activeTeam = state.currentTeam;
         document.getElementById('blue-ready-switch').style.display = state.gameStarted?'none':'flex';
         document.getElementById('red-ready-switch').style.display = state.gameStarted?'none':'flex';
         if(!state.gameStarted) {
             state.ready.blue ? document.getElementById('blue-ready-switch').classList.add('ready-on') : document.getElementById('blue-ready-switch').classList.remove('ready-on');
             state.ready.red ? document.getElementById('red-ready-switch').classList.add('ready-on') : document.getElementById('red-ready-switch').classList.remove('ready-on');
         }
         
         document.getElementById('blue-name-display').innerText = state.blueName;
         document.getElementById('red-name-display').innerText = state.redName;

         // --- ОБНОВЛЕНИЕ АВАТАРОК ---
         const blueAv = document.getElementById('blue-avatar');
         if (state.blueAvatar && state.blueDiscordId) {
             blueAv.src = `https://cdn.discordapp.com/avatars/${state.blueDiscordId}/${state.blueAvatar}.png`;
             blueAv.style.display = 'block';
         } else { blueAv.style.display = 'none'; }

         const redAv = document.getElementById('red-avatar');
         if (state.redAvatar && state.redDiscordId) {
             redAv.src = `https://cdn.discordapp.com/avatars/${state.redDiscordId}/${state.redAvatar}.png`;
             redAv.style.display = 'block';
         } else { redAv.style.display = 'none'; }
         // ---------------------------
         
         let txt = "WAITING...";
         if(state.immunityPhaseActive) txt = `IMMUNITY: ${state.currentTeam} ${state.currentAction}`;
         else if(state.gameStarted) txt = `${state.currentTeam} IS ${state.currentAction==='ban'?'BANNING':'PICKING'}`;
         
         if (savedData) txt = "MATCH COMPLETED";
         
         document.getElementById('status').innerText = txt.toUpperCase();

         updateImmunityTop(state);

         const skipBtn = document.getElementById('skip-btn');
         const isMyTurn = (myRole === state.currentTeam);
         
         skipBtn.classList.remove('skip-left', 'skip-right');
         
         if (state.immunityPhaseActive && isMyTurn && !savedData) {
             skipBtn.style.display = 'block';
             if (state.currentTeam === 'blue') {
                 skipBtn.classList.add('skip-left');
             } else {
                 skipBtn.classList.add('skip-right');
             }
         } else {
             skipBtn.style.display = 'none';
         }

         const idx = state.stepIndex - 1;
         const currentSchema = DRAFT_RULES[currentDraftType];
         
         if(!state.immunityPhaseActive && currentSchema) {
             const len = currentSchema.length;
             for(let i=0; i<len; i++) {
                 const n = document.getElementById(`step-node-${i}`);
                 if(!n) continue;
                 n.classList.remove('step-active','step-done');
                 if(i < idx) n.classList.add('step-done');
                 else if(i === idx && state.gameStarted && !savedData) {
                     n.classList.add('step-active');
                     setTimeout(() => n.scrollIntoView({behavior:'smooth', block:'center'}), 50);
                 }
             }
         }

         renderSlots(state);

         document.querySelectorAll('.char-option').forEach(el => el.classList.remove('disabled', 'immunity-highlight'));
         state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
         [...state.bluePicks, ...state.redPicks].forEach(id => document.getElementById(`char-${id}`)?.classList.add('disabled'));
         if(state.immunityPhaseActive) {
             [...state.immunityBans, ...state.immunityPool].forEach(id => {
                 if (id !== 'skipped') document.getElementById(`char-${id}`)?.classList.add('disabled');
             });
         } else {
             const step = currentSchema ? currentSchema[idx] : null;
             const isImmunityTurn = step && step.immunity;
             state.immunityPool.forEach(id => {
                 if(id === 'skipped') return;
                 const el = document.getElementById(`char-${id}`);
                 if(!el) return;
                 if(state.currentAction === 'ban') el.classList.add('disabled');
                 else if (state.currentAction === 'pick') {
                     if(isImmunityTurn) {
                         const myPicks = activeTeam === 'blue' ? state.bluePicks : state.redPicks;
                         if(!myPicks.includes(id)) { el.classList.remove('disabled'); el.classList.add('immunity-highlight'); }
                     } else el.classList.add('disabled');
                 }
             });
         }
         if(state.gameStarted && myRole !== 'spectator' && myRole !== state.currentTeam && !savedData) {
             document.querySelectorAll('.char-option').forEach(el => el.classList.add('disabled'));
         }
     }

     function getStepsFor(schema, team, type) {
         if (!schema) return [];
         return schema
             .map((step, index) => ({ ...step, globalIndex: index + 1 }))
             .filter(step => step.team === team && step.type === type)
             .map(step => ({ num: step.globalIndex, immunity: step.immunity }));
     }

     function renderSlots(state) {
         const currentSchema = DRAFT_RULES[currentDraftType];
         if (!currentSchema) return;

         const blueBanSteps = getStepsFor(currentSchema, 'blue', 'ban');
         const redBanSteps = getStepsFor(currentSchema, 'red', 'ban');
         const bluePickSteps = getStepsFor(currentSchema, 'blue', 'pick');
         const redPickSteps = getStepsFor(currentSchema, 'red', 'pick');

         const fill = (containerId, items, stepData, isBan) => {
             const div = document.getElementById(containerId);
             if(!div) return;
             div.innerHTML = ''; 
             stepData.forEach((step, i) => {
                 const slot = document.createElement('div');
                 slot.className = 'slot-circle';
                 if (isBan) slot.classList.add('slot-ban');
                 if (step.immunity) slot.classList.add('slot-immunity-pick');
                 
                 if (!state.immunityPhaseActive && state.gameStarted && !savedData &&
                     step.num === state.stepIndex) {
                     slot.classList.add('active-slot');
                 }

                 let charId = null;
                 if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];

                 if (charId) {
                     let allFlat = []; Object.values(charsData).forEach(arr => allFlat.push(...arr));
                     const char = allFlat.find(c => c.id === charId);
                     if (char) slot.innerHTML = `<img src="${char.img}">`;
                 } else slot.innerHTML = `<span class="step-number">${step.num}</span>`;
                 div.appendChild(slot);
             });
         };

         fill('blue-bans', state.bans.filter(b => b.team === 'blue'), blueBanSteps, true);
         fill('red-bans', state.bans.filter(b => b.team === 'red'), redBanSteps, true);
         
         if (currentDraftType === 'generals_2') {
             fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
             fill('blue-picks-2', [], [], false); 
             fill('red-picks-1', state.redPicks, redPickSteps, false);
             fill('red-picks-2', [], [], false);
         } else if (currentDraftType === 'classic') {
             fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
             fill('blue-picks-2', [], [], false);
             fill('red-picks-1', state.redPicks, redPickSteps, false);
             fill('red-picks-2', [], [], false);
         } else {
             fill('blue-picks-1', state.bluePicks.slice(0, 5), bluePickSteps.slice(0, 5), false);
             fill('blue-picks-2', state.bluePicks.slice(5, 9), bluePickSteps.slice(5, 9), false);
             fill('red-picks-1', state.redPicks.slice(0, 5), redPickSteps.slice(0, 5), false);
             fill('red-picks-2', state.redPicks.slice(5, 9), redPickSteps.slice(5, 9), false);
         }
     }
 </script>

<%- include('../partials/footer') %>
